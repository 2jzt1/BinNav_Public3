<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后端下载图标测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffe8e8; border-color: #f44336; }
        .warning { background: #fff3cd; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        input { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 300px;
            font-size: 14px;
        }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 12px;
            white-space: pre-wrap;
        }
        .icon-preview {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background: white;
        }
        .icon-preview img {
            width: 32px;
            height: 32px;
            display: block;
            margin: 0 auto 5px;
            border: 1px solid #eee;
        }
        .icon-preview .label {
            font-size: 12px;
            color: #666;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #2196f3;
            background: #f8f9fa;
        }
        .step.completed {
            border-left-color: #4caf50;
            background: #f1f8e9;
        }
        .step.failed {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 13px;
        }
        .log-info { background: #e3f2fd; }
        .log-success { background: #e8f5e8; }
        .log-error { background: #ffebee; }
        .log-warning { background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 后端下载图标测试</h1>
        <p>测试EdgeOne Functions从外网URL下载图标并保存到GitHub的功能</p>
        
        <div class="section">
            <h3>1. 测试参数</h3>
            <div>
                <label>域名:</label>
                <input type="text" id="domain" placeholder="如: github.com" value="github.com">
            </div>
            <div>
                <label>图标URL:</label>
                <input type="text" id="iconUrl" placeholder="图标的完整URL" value="https://www.google.com/s2/favicons?domain=github.com&sz=32">
            </div>
            <button onclick="testDownload()" id="testBtn">开始测试后端下载</button>
            <button onclick="testAPI()">测试API连通性</button>
            <button onclick="testNetworkAccess()">测试网络访问</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
        
        <div class="section">
            <h3>2. 测试步骤</h3>
            <div id="steps">
                <div class="step" id="step1">
                    <strong>步骤1:</strong> 验证图标URL可访问性
                    <div id="step1-detail"></div>
                </div>
                <div class="step" id="step2">
                    <strong>步骤2:</strong> 调用后端下载API
                    <div id="step2-detail"></div>
                </div>
                <div class="step" id="step3">
                    <strong>步骤3:</strong> 验证下载结果
                    <div id="step3-detail"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>3. 图标预览</h3>
            <div id="icon-preview">
                <p>点击测试按钮开始...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>4. 详细日志</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStep(stepNum, status, detail = '') {
            const step = document.getElementById(`step${stepNum}`);
            const detailDiv = document.getElementById(`step${stepNum}-detail`);
            
            step.className = `step ${status}`;
            if (detail) {
                detailDiv.innerHTML = detail;
            }
        }

        async function testNetworkAccess() {
            log('测试EdgeOne Functions网络访问能力', 'info');

            const iconUrl = document.getElementById('iconUrl').value.trim() || 'https://www.google.com/s2/favicons?domain=github.com&sz=32';

            try {
                const response = await fetch('/api/test-network', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        testUrl: iconUrl
                    })
                });

                log(`网络测试API响应状态: ${response.status}`, 'info');

                if (response.ok) {
                    const result = await response.json();
                    log(`网络测试结果: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');

                    if (result.success) {
                        log(`✅ EdgeOne Functions可以访问外网`, 'success');
                        log(`📊 响应状态: ${result.result.status}`, 'info');
                        log(`📦 数据大小: ${result.result.responseSize} bytes`, 'info');
                        log(`⏱️ 耗时: ${result.result.duration}ms`, 'info');
                    } else {
                        log(`❌ 网络访问失败: ${result.error}`, 'error');
                        log(`🔍 可能原因: ${result.possibleCauses?.join(', ')}`, 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log(`网络测试API错误: ${errorText}`, 'error');
                }

            } catch (error) {
                log(`❌ 网络测试失败: ${error.message}`, 'error');
            }
        }

        async function testAPI() {
            log('测试upload-icon API连通性', 'info');

            try {
                // 测试OPTIONS请求
                const optionsResponse = await fetch('/api/upload-icon', {
                    method: 'OPTIONS'
                });

                log(`OPTIONS响应状态: ${optionsResponse.status}`, optionsResponse.ok || optionsResponse.status === 204 ? 'success' : 'error');

                if (optionsResponse.ok || optionsResponse.status === 204) {
                    log('✅ upload-icon API OPTIONS请求正常', 'success');

                    // 测试POST请求（发送无效数据看错误响应）
                    try {
                        const postResponse = await fetch('/api/upload-icon', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                test: 'connectivity'
                            })
                        });

                        log(`POST测试响应状态: ${postResponse.status}`, 'info');

                        if (postResponse.ok) {
                            const result = await postResponse.json();
                            log(`POST响应: ${JSON.stringify(result)}`, 'info');
                        } else {
                            const errorText = await postResponse.text();
                            log(`POST错误响应: ${errorText}`, 'warning');
                        }

                        log('✅ upload-icon API POST路由存在', 'success');

                    } catch (postError) {
                        log(`❌ POST请求失败: ${postError.message}`, 'error');
                    }
                } else {
                    log('❌ upload-icon API OPTIONS请求失败', 'error');
                }

            } catch (error) {
                log(`❌ API连通性测试失败: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('icon-preview').innerHTML = '<p>点击测试按钮开始...</p>';
            
            // 重置步骤状态
            for (let i = 1; i <= 3; i++) {
                updateStep(i, '', '');
            }
        }

        async function testDownload() {
            const domain = document.getElementById('domain').value.trim();
            const iconUrl = document.getElementById('iconUrl').value.trim();
            const testBtn = document.getElementById('testBtn');
            
            if (!domain || !iconUrl) {
                log('请填写域名和图标URL', 'error');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            clearLog();
            
            log(`开始测试后端下载: ${domain}`, 'info');
            log(`图标URL: ${iconUrl}`, 'info');
            
            try {
                // 步骤1: 验证图标URL可访问性
                log('步骤1: 验证图标URL可访问性', 'info');
                updateStep(1, '', '正在验证...');
                
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    const imageTest = new Promise((resolve, reject) => {
                        img.onload = () => {
                            log(`图标可访问，尺寸: ${img.width}x${img.height}`, 'success');
                            updateStep(1, 'completed', `✅ 图标可访问 (${img.width}x${img.height})`);
                            resolve();
                        };
                        img.onerror = () => {
                            log('图标URL无法访问或有CORS限制', 'warning');
                            updateStep(1, 'failed', '⚠️ 图标URL访问受限，但后端可能仍能下载');
                            resolve(); // 继续测试，因为后端可能能访问
                        };
                        img.src = iconUrl;
                    });
                    
                    await imageTest;
                } catch (error) {
                    log(`图标验证失败: ${error.message}`, 'warning');
                    updateStep(1, 'failed', `⚠️ ${error.message}`);
                }
                
                // 步骤2: 调用后端下载API
                log('步骤2: 调用后端下载API', 'info');
                updateStep(2, '', '正在调用API...');
                
                const response = await fetch('/api/upload-icon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        iconUrl: iconUrl
                    })
                });
                
                log(`API响应状态: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                log(`API响应: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                if (result.success) {
                    updateStep(2, 'completed', `✅ 下载成功，文件: ${result.fileName}`);
                    
                    // 步骤3: 验证下载结果
                    log('步骤3: 验证下载结果', 'info');
                    updateStep(3, '', '正在验证下载的图标...');
                    
                    // 显示图标预览
                    const previewDiv = document.getElementById('icon-preview');
                    previewDiv.innerHTML = `
                        <div class="icon-preview">
                            <img src="${iconUrl}" alt="原始图标" onerror="this.style.border='2px solid red'">
                            <div class="label">原始图标</div>
                        </div>
                        <div class="icon-preview">
                            <img src="${result.staticPath}" alt="缓存图标" onerror="this.style.border='2px solid red'">
                            <div class="label">缓存图标</div>
                        </div>
                    `;
                    
                    // 测试缓存图标是否可访问
                    const cachedImg = new Image();
                    cachedImg.onload = () => {
                        log('缓存图标验证成功', 'success');
                        updateStep(3, 'completed', `✅ 缓存图标可正常访问: ${result.staticPath}`);
                    };
                    cachedImg.onerror = () => {
                        log('缓存图标访问失败，可能需要等待GitHub Pages更新', 'warning');
                        updateStep(3, 'failed', '⚠️ 缓存图标暂时无法访问，请稍后再试');
                    };
                    cachedImg.src = result.staticPath;
                    
                    log(`✅ 后端下载测试成功！`, 'success');
                    log(`📁 文件路径: ${result.staticPath}`, 'info');
                    log(`📊 文件大小: ${result.size} bytes`, 'info');
                    log(`🔗 GitHub提交: ${result.commit?.url}`, 'info');
                    
                } else {
                    updateStep(2, 'failed', `❌ ${result.message || '下载失败'}`);
                    throw new Error(result.message || '下载失败');
                }
                
            } catch (error) {
                log(`❌ 测试失败: ${error.message}`, 'error');
                if (!document.getElementById('step2').classList.contains('completed')) {
                    updateStep(2, 'failed', `❌ ${error.message}`);
                }
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '开始测试后端下载';
            }
        }
        
        // 页面加载时的说明
        window.onload = function() {
            log('后端下载图标测试页面已加载', 'info');
            log('此测试将验证EdgeOne Functions从外网URL下载图标的功能', 'info');
        };
    </script>
</body>
</html>
